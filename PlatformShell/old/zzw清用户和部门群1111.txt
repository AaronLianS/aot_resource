一：禁用用户

mysql> create table hyj_user_token(user_number int);
Query OK, 0 rows affected (0.30 sec)

mysql> insert into hyj_user_token  select user_number from aas_user_token_his group by user_number;
Query OK, 28457 rows affected (1.08 sec)
Records: 28457  Duplicates: 0  Warnings: 0

mysql> insert into hyj_user_token  select user_number from aas_user_token group by user_number;
Query OK, 61562 rows affected (0.79 sec)
Records: 61562  Duplicates: 0  Warnings: 0

mysql> create table hyj_user_token_new(user_number int);
Query OK, 0 rows affected (0.07 sec)

mysql> insert into hyj_user_token_new select user_number from hyj_user_token group by user_number;
Query OK, 68600 rows affected (1.44 sec)
Records: 68600  Duplicates: 0  Warnings: 0

create index idx_hyj_user_token_new on hyj_user_token_new(user_number);

alter table hyj_user_token_new add create_time int;
update hyj_user_token_new a inner join uic_user_info b 
 on a.user_number=b.user_number
set a.create_time=b.create_time;


create table hyj_user_token_nologging(user_number int);
insert into hyj_user_token_nologging 
select user_number from uic_user_info a 
 where not exists(select 1 from hyj_user_token_new b where a.user_number=b.user_number);
 
 
 alter table hyj_user_token_nologging add create_time int;
 create index idx_hyj_user_token_nologging on hyj_user_token_nologging(user_number);
 begin;
 update hyj_user_token_nologging a inner join uic_user_info b 
 on a.user_number=b.user_number
set a.create_time=b.create_time;

 commit;
 
 create index adfwe on hyj_user_token_nologging(create_time);
 
 create table  hyj_user_token_nologging_delete(user_number int);
 insert into hyj_user_token_nologging_delete 
  select user_number from hyj_user_token_nologging order by create_time  limit 40000;
 
 create index adfwdfe on hyj_user_token_nologging_delete(user_number);
 
 
数据库对没有登录的用户禁用（hyj_user_token_nologging_delete是我过滤5个月没有登录的4000个号码表)：
 
 begin;
update aas_user_login a inner join hyj_user_token_nologging_delete b
 on a.user_number=b.user_number set state=1 ;
 commit;
 

 
对于有登录用的用户禁用

curl -H "Content-Type:application/json" -X POST --data '{"userNumber": "Basica0ezsrfn1ypsoqpcb8R549"}' "http://172.16.39.62:8015/uic-server-user/uic/media/user/accountCancel"

 
启用(目前只有办法用数据SQL,没有接口,估计要清redis)：
update aas_user_login a  set state=0 where a.user_number=xxxx;

 

 
二：所有组织信息 
 
mysql> select enter_name from uic_enterprise_info;
+-----------------------------+
| enter_name                  |
+-----------------------------+
| 新媒通                      |
| 新媒通上海平台              |
| 新媒通云南平台              |
| 新媒通内蒙古平台            |
| 新媒通北京平台              |
| 新媒通吉林平台              |
| 新媒通四川平台              |
| 新媒通天津平台              |
| 新媒通宁夏平台              |
| 新媒通安徽平台              |
| 新媒通山东平台              |
| 新媒通山西平台              |
| 新媒通广东平台              |
| 新媒通广西平台              |
| 新媒通新疆兵团平台          |
| 新媒通新疆平台              |
| 新媒通江苏平台              |
| 新媒通江西平台              |
| 新媒通河北平台              |
| 新媒通河南平台              |
| 新媒通浙江平台              |
| 新媒通海南平台              |
| 新媒通湖北平台              |
| 新媒通湖南平台              |
| 新媒通甘肃平台              |
| 新媒通福建平台              |
| 新媒通西藏平台              |
| 新媒通贵州平台              |
| 新媒通辽宁平台              |
| 新媒通重庆平台              |
| 新媒通陕西平台              |
| 新媒通青海平台              |
| 新媒通黑龙江平台            |


说明：
mysql主库上执行
node1.simba.pro 这个是每个环境都不一样，要问曾斌

curl -d "enterprise=1&deptId=2&groupNumber=3&userNumber=4" "http://172.16.39.62:8015/uic-server-group/uic/group/dissolveDeptOrEnterpriseGroup"

select count(1)  from uic_group_info a inner join uic_enterprise_info b on a.enterprise_id=b.id 
where a.group_type=3 and a.state=0 and b.enter_name='新媒通新疆兵团平台';
   where a.group_type=3 and b.enter_name='新媒通新疆兵团平台';
以下为脚本内容和执行步骤

curl "http://172.16.39.62:8015/uic-server-group/uic/group/dissolveDeptOrEnterpriseGroup?enterprise=1&deptId=2&groupNumber=3&userNumber=4

rm -rf /var/lib/mysql-files/a.sh
mysql -u root -pwww.simba.pro simba_db1
select concat('curl "http://172.16.39.62:8015/uic-server-group/uic/group/dissolveDeptOrEnterpriseGroup?enterpriseId=',a.enterprise_id,'&deptId=',a.dept_id,'&groupNumber=',a.group_number,'&userNumber=',b.user_number,'"') 
  into outfile '/var/lib/mysql-files/a.sh' from uic_group_info a inner join uic_enterprise_info b on a.enterprise_id=b.id
   where a.group_type=3 and a.state=0 and b.enter_name='新媒通新疆兵团平台';
exit;  
chmod +x /var/lib/mysql-files/a.sh
wc -l /var/lib/mysql-files/a.sh
/var/lib/mysql-files/a.sh


三：离线消息临时处理

CREATE TABLE `im_offline_msg_hyj` (
  `ID` int(11) NOT NULL AUTO_INCREMENT,
  `UID` int(11) NOT NULL,
  `MSG_MID` varchar(32) NOT NULL,
  `SESSION_ID` varchar(32) NOT NULL,
  `SESSION_TM` bigint(20) NOT NULL,
  PRIMARY KEY (`ID`),
  UNIQUE KEY `UNIQUE_SESSION_ID` (`UID`,`MSG_MID`,`SESSION_ID`)
) ENGINE=InnoDB AUTO_INCREMENT=508509157 DEFAULT CHARSET=utf8mb4 ;

alter table im_offline_msg rename to im_offline_msg_0914;
alter table im_offline_msg_hyj rename to im_offline_msg;